import express from "express";
import cors from "cors";

import { env } from "./config/env.js";
import { verifyFirebaseToken } from "./middlewares/authMiddleware.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import { userRoutes } from "./routes/userRoutes.js";
import { chatRoutes } from "./routes/chatRoutes.js";
import { adminRoutes } from "./routes/adminRoutes.js";
import { stripeRoutes } from "./routes/stripeRoutes.js";

const app = express();

// 1) Stripe webhook RAW Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ express.json
app.post(
  "/stripe/webhook",
  express.raw({ type: "application/json" }),
  (req, res, next) => {
    // ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø±Ø§ÙˆØªØ± (Ù„Ø£Ù† Ø§Ù„Ø±Ø§ÙˆØªØ± Ù…Ø³Ø¬Ù„ Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±)
    next();
  }
);

// 2) Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙŠØ¯Ù„ ÙˆÙŠØ±
app.use(cors());

// âš ï¸ Ù…Ù‡Ù…: json Ø¨Ø¹Ø¯ webhook raw
app.use(express.json());

// 3) Auth decode (ÙŠØ³Ù…Ø­ ÙŠÙƒÙˆÙ† token ÙØ§Ø¶ÙŠ)
app.use(verifyFirebaseToken);

// 4) Routes
app.get("/health", (req, res) => {
  res.json({ ok: true, name: "BlueMind.AI", time: new Date().toISOString() });
});

app.use(userRoutes);
app.use(chatRoutes);
app.use(adminRoutes);

// Ø±Ø§ÙˆØªØ± Stripe (ÙÙŠÙ‡ /stripe/webhook + /stripe/create-checkout-session)
app.use(stripeRoutes);

// 5) Global error handler
app.use(errorHandler);

app.listen(env.PORT, () => {
  console.log(`ðŸš€ BlueMind.AI server running on http://localhost:${env.PORT}`);
});